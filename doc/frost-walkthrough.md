FROST Threshold Signing Walkthrough
====================================

This document walks through using `zcash-devtool` to set up a FROST
threshold-signing wallet for Zcash Orchard. FROST (Flexible Round-Optimized
Schnorr Threshold Signatures) allows a group of participants to jointly control
a shielded wallet such that any `t` out of `n` participants can authorize a
spend, but no fewer than `t` can do so alone.

This walkthrough demonstrates a 2-of-3 setup: three participants share control
of a wallet, and any two of them can cooperate to sign a transaction.

Prerequisites
-------------

You will need `zcash-devtool` built with the `frost` feature:

```bash
cargo build --release --features frost
```

For brevity, the examples below use `zcash-devtool` as the binary name. If
running from the source tree, substitute `cargo run --release --features frost --`.

Each participant needs an `age` identity file for encrypting their FROST key
material at rest. If you don't already have one, generate it:

```bash
age-keygen -o ~/frost-identity.txt
```

Overview
--------

The FROST workflow has two phases:

1. **Distributed Key Generation (DKG)** -- A one-time interactive ceremony
   where all participants cooperate to generate a shared Orchard spending key.
   Each participant ends up with a key share and a common viewing key. This
   produces a standard Unified Address that anyone can send funds to.

2. **Threshold Signing** -- When spending funds, a coordinator and at least
   `min_signers` participants perform a two-round signing ceremony over a PCZT
   (Partially Created Zcash Transaction).

In both phases, participants exchange JSON messages. The current implementation
uses copy-paste over a secure out-of-band channel (e.g. an encrypted group
chat). No direct network connection between participants is required.

Key Architecture
----------------

An Orchard Full Viewing Key (FVK) consists of three 32-byte components:

| Component | Purpose | Source |
|-----------|---------|--------|
| `ak` | Spend validating key | FROST DKG group public key |
| `nk` | Nullifier deriving key | Random, generated by coordinator |
| `rivk` | Commit-ivk randomness | Random, generated by coordinator |

Only `ak` is threshold-distributed via the DKG. The `nk` and `rivk` components
are generated by the coordinator and shared with all participants in plaintext.
This means **every participant has full viewing capability** -- they can all
derive addresses, scan the chain, and see balances. Spending is the only
operation that requires threshold cooperation.

The resulting FVK is wrapped in a Unified Full Viewing Key (UFVK) and imported
into each participant's wallet as a view-only account. Unified Addresses are
derived from this UFVK in the standard way.

Phase 1: Distributed Key Generation
------------------------------------

The DKG is a three-round interactive protocol. One participant is designated
the coordinator (responsible for generating `nk` and `rivk`); all other
participants are non-coordinators. All participants run the same command with
different flags.

### Setup

Decide on:
- **Threshold** (`min_signers`): minimum number of signers needed to spend
  (e.g. 2)
- **Total participants** (`max_signers`): total number of key holders (e.g. 3)
- **Participant indices**: each participant gets a unique 1-based index
  (1, 2, or 3)
- **Birthday height**: a recent block height for wallet scanning (avoids
  scanning the entire chain). You can find the current tip height from a
  block explorer or by querying a lightwalletd server.
- **Lightwalletd server**: the `-s` flag specifies a lightwalletd server
  alias. The examples below use `-s zecrocks` for `zec.rocks`; see
  `zcash-devtool wallet --help` for other options.

### Coordinator (participant 1)

```bash
zcash-devtool wallet -w ~/frost-wallet frost-dkg \
  --name "treasury" \
  --min-signers 2 \
  --max-signers 3 \
  --participant-index 1 \
  --identity ~/frost-identity.txt \
  --birthday 2700000 \
  --coordinator \
  -s zecrocks
```

### Other participants (participants 2 and 3)

```bash
zcash-devtool wallet -w ~/frost-wallet frost-dkg \
  --name "treasury" \
  --min-signers 2 \
  --max-signers 3 \
  --participant-index 2 \
  --identity ~/frost-identity.txt \
  --birthday 2700000 \
  -s zecrocks
```

(Participant 3 uses `--participant-index 3`.)

### Interactive rounds

The DKG proceeds through three rounds of message exchange. The CLI guides
each participant through the process with prompts.

**Round 1 -- Commitments:**

Each participant's CLI outputs a Round 1 JSON message. Every participant sends
their message to all other participants. Each participant then pastes the
messages received from the others (one per line).

```
=== DKG Round 1: Generating commitments ===

Your Round 1 package (send to all other participants):
{"identifier":"0100000000000000...","package":{"commitment":["abcd..."],"proof_of_knowledge":"ef01..."}}

Paste 2 Round 1 package(s) from other participants (one per line):
```

**Round 2 -- Secret shares:**

After processing Round 1, each participant's CLI outputs one Round 2 message
per other participant. These are point-to-point: the message for participant 2
should only be sent to participant 2.

```
=== DKG Round 2: Computing secret shares ===

Round 2 package for participant <id> (send privately):
{"from":"...","to":"...","package":{"secret_share":"..."}}

Paste 2 Round 2 package(s) addressed to you (one per line):
```

**Round 3 -- Finalization and FVK exchange:**

Round 3 runs automatically. The coordinator's CLI then generates random `nk`
and `rivk` values and outputs an FVK share message:

```
=== Coordinator: Generating shared nk and rivk ===

FVK share message (send to all participants via secure channel):
{"nk_hex":"...","rivk_hex":"..."}
```

Non-coordinator participants paste this message when prompted.

### What happens at the end

After the DKG completes, each participant's wallet has:

1. A **view-only account** in the `zcash_client_sqlite` database, imported from
   the UFVK constructed from `ak || nk || rivk`.
2. A `frost.toml` file in the wallet directory containing:
   - The participant's FROST key package (encrypted with their `age` identity)
   - The group's public key package (unencrypted)
   - The shared `nk` and `rivk` values
   - The participant's identifier and threshold parameters

The CLI prints the account UUID, which you'll need for subsequent commands.

Receiving Funds
---------------

After the DKG, generate a Unified Address from the FROST account:

```bash
zcash-devtool wallet -w ~/frost-wallet generate-address <ACCOUNT_UUID>
```

This produces a standard Unified Address. Senders do not need to know that it
is backed by a FROST threshold key -- they send to it like any other Zcash
address.

Every participant can independently generate the same addresses from their
copy of the UFVK.

Scanning and Balance
--------------------

Sync the wallet to detect incoming payments:

```bash
zcash-devtool wallet -w ~/frost-wallet sync -s zecrocks
```

Check the balance:

```bash
zcash-devtool wallet -w ~/frost-wallet balance <ACCOUNT_UUID>
```

Every participant can sync and check balances independently, since they all
hold the full viewing key.

Phase 2: Spending with FROST Threshold Signing
-----------------------------------------------

Spending from a FROST wallet is a multi-step process involving PCZT creation,
a two-round signing ceremony, and broadcast.

### Step 1: Create a PCZT

Any participant with a synced wallet can create the unsigned transaction:

```bash
zcash-devtool pczt -w ~/frost-wallet create <ACCOUNT_UUID> \
  --address <RECIPIENT_ADDRESS> \
  --value <AMOUNT_IN_ZATOSHIS> \
  --memo "Payment from FROST wallet" \
  > tx.pczt
```

This outputs a binary PCZT file containing Orchard actions ready for signing.

### Step 2: Coordinator initiates signing

The coordinator (who can be any participant -- not necessarily the same one
from the DKG) reads the PCZT from stdin and orchestrates the signing ceremony:

```bash
cat tx.pczt | zcash-devtool pczt -w ~/frost-wallet frost-sign \
  --identity ~/frost-identity.txt \
  --num-signers 2 \
  [ACCOUNT_UUID] \
  > tx_signed.pczt
```

The `ACCOUNT_UUID` argument is optional if only one FROST account exists in
`frost.toml`. If you have multiple FROST accounts, you must specify which one
to sign with.

The coordinator's CLI:

1. Extracts the sighash and spend auth randomizers (`alpha`) from the PCZT
2. Outputs a **Signing Request** (JSON) to send to all participants
3. Waits for Round 1 responses (commitments) from each participant
4. Outputs a **Round 2 Request** (JSON) to send to all participants
5. Waits for Round 2 responses (signature shares) from each participant
6. Aggregates signature shares into final signatures
7. Writes the signed PCZT to stdout

### Step 3: Participants sign

Each participating signer runs:

```bash
zcash-devtool pczt -w ~/frost-wallet frost-participate \
  --identity ~/frost-identity.txt \
  [ACCOUNT_UUID]
```

As with `frost-sign`, the `ACCOUNT_UUID` is optional if only one FROST account
exists.

The participant's CLI:

1. Loads their encrypted FROST key package from `frost.toml` in the wallet
   directory
2. Waits for the Signing Request (paste from coordinator)
3. Generates nonce commitments and outputs a **Round 1 Response** (JSON)
4. Waits for the Round 2 Request (paste from coordinator)
5. Computes signature shares and outputs a **Round 2 Response** (JSON)

### Step 4: Broadcast

After the coordinator has the signed PCZT, send it to the network:

```bash
cat tx_signed.pczt | zcash-devtool pczt -w ~/frost-wallet send -s zecrocks
```

Signing Ceremony Message Flow
-----------------------------

For a 2-of-3 setup with participant A as coordinator and participants B and C
as signers:

```
                 A (coordinator)              B (signer)         C (signer)

  PCZT -------> frost-sign                   frost-participate   frost-participate
                  |
                  |--- Signing Request -----> paste              paste
                  |                             |                  |
                  |    paste <--- Round 1 Resp -+                  |
                  |    paste <--- Round 1 Resp --------------------+
                  |
                  |--- Round 2 Request -----> paste              paste
                  |                             |                  |
                  |    paste <--- Round 2 Resp -+                  |
                  |    paste <--- Round 2 Resp --------------------+
                  |
                  v
             Signed PCZT
```

All messages are JSON and exchanged by copy-paste over a secure channel.

File Layout
-----------

After completing the DKG, the wallet directory contains:

```
~/frost-wallet/
  blockmeta.sqlite      # Block metadata (standard)
  blocks/               # Compact blocks (standard)
  data.sqlite           # Wallet database with FROST view-only account
  frost.toml            # FROST key material and configuration
```

The `frost.toml` file stores per-account FROST configuration:

```toml
[[accounts]]
name = "treasury"
account_uuid = "..."
min_signers = 2
max_signers = 3
key_package = """
-----BEGIN AGE ENCRYPTED FILE-----
...
-----END AGE ENCRYPTED FILE-----
"""
public_key_package = '{"verifying_key":"...","signer_pubkeys":{"...":"..."}}'
nk_bytes = "..."
rivk_bytes = "..."
identifier = "..."
```

The `key_package` field contains the participant's secret signing share,
encrypted with their `age` identity. The `public_key_package` field is
unencrypted since it contains only public information.

Security Considerations
-----------------------

- **Viewing key is fully shared.** All participants can see the wallet's
  complete transaction history. If you need to restrict viewing to a subset
  of signers, a different design would be required.

- **Round 2 DKG messages are secret shares.** These must be sent privately
  to their intended recipients. Do not broadcast them.

- **The `nk`/`rivk` FVK share from the coordinator is sensitive.** Anyone
  who obtains these values along with the group public key can derive the
  full viewing key and see all transactions. Send it over an encrypted
  channel.

- **Key packages are encrypted at rest.** Each participant's signing share
  is encrypted with their `age` identity and stored in `frost.toml`. Protect
  both the `frost.toml` and the `age` identity file.

- **This is experimental software.** As with all of `zcash-devtool`, do not
  use this for production wallets or significant funds.

Troubleshooting
---------------

**"No FROST accounts found in frost.toml"**

Make sure you pass `-w <wallet_dir>` to the `wallet` or `pczt` parent command,
not to the subcommand itself. The wallet directory must be the same one used
during the DKG. For example:
```bash
# Correct -- -w is on the pczt parent command:
zcash-devtool pczt -w ~/frost-wallet frost-participate ...

# Wrong -- -w is missing, so frost.toml won't be found:
zcash-devtool pczt frost-participate ...
```

**"Multiple FROST accounts found; please specify account UUID"**

If you have run the DKG more than once into the same wallet directory, your
`frost.toml` will contain multiple `[[accounts]]` entries. Pass the account
UUID as a positional argument to `frost-sign` or `frost-participate`.

**"Failed to parse Round N package/response"**

Check that you are pasting a complete, single-line JSON message. Avoid
trailing whitespace or line breaks within the JSON. Each message must be
pasted as exactly one line.

**"Received our own Round 1 package"**

During the DKG, do not paste your own output back to yourself. Only paste
messages from the *other* participants.

**Commands not found (`frost-dkg`, `frost-sign`, `frost-participate`)**

These commands are only available when the binary is built with the `frost`
feature flag. Rebuild with:
```bash
cargo build --release --features frost
```
